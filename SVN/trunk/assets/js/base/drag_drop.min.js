function _ToolManCoordinate(e,t,n){this.factory=e;this.x=isNaN(t)?0:t;this.y=isNaN(n)?0:n}function _ToolManDragGroup(e,t){this.factory=e;this.element=t;this._handle=null;this._thresholdDistance=0;this._transforms=new Array;this._listeners=new Array;this._listeners["draginit"]=new Array;this._listeners["dragstart"]=new Array;this._listeners["dragmove"]=new Array;this._listeners["dragend"]=new Array}function _ToolManDragEvent(e,t,n){this.type=e;this.group=n;this.mousePosition=ToolMan.coordinates().mousePosition(t);this.mouseOffset=ToolMan.coordinates().mouseOffset(t);this.transformedMouseOffset=this.mouseOffset;this.topLeftPosition=ToolMan.coordinates().topLeftPosition(n.element);this.topLeftOffset=ToolMan.coordinates().topLeftOffset(n.element)}var ToolMan={events:function(){if(!ToolMan._eventsFactory)throw"ToolMan Events module isn't loaded";return ToolMan._eventsFactory},css:function(){if(!ToolMan._cssFactory)throw"ToolMan CSS module isn't loaded";return ToolMan._cssFactory},coordinates:function(){if(!ToolMan._coordinatesFactory)throw"ToolMan Coordinates module isn't loaded";return ToolMan._coordinatesFactory},drag:function(){if(!ToolMan._dragFactory)throw"ToolMan Drag module isn't loaded";return ToolMan._dragFactory},dragsort:function(){if(!ToolMan._dragsortFactory)throw"ToolMan DragSort module isn't loaded";return ToolMan._dragsortFactory},helpers:function(){return ToolMan._helpers},cookies:function(){if(!ToolMan._cookieOven)throw"ToolMan Cookie module isn't loaded";return ToolMan._cookieOven},junkdrawer:function(){return ToolMan._junkdrawer}};ToolMan._helpers={map:function(e,t){for(var n=0,r=e.length;n<r;n++)t(e[n])},nextItem:function(e,t){if(e==null)return;var n=e.nextSibling;while(n!=null){if(n.nodeName==t)return n;n=n.nextSibling}return null},previousItem:function(e,t){var n=e.previousSibling;while(n!=null){if(n.nodeName==t)return n;n=n.previousSibling}return null},moveBefore:function(e,t){var n=e.parentNode;n.removeChild(e);n.insertBefore(e,t)},moveAfter:function(e,t){var n=e.parentNode;n.removeChild(e);n.insertBefore(e,t?t.nextSibling:null)}};ToolMan._junkdrawer={serializeList:function(e){var t=e.getElementsByTagName("li");var n=new Array;for(var r=0,i=t.length;r<i;r++){var s=t[r];n.push(ToolMan.junkdrawer()._identifier(s))}return n.join("|")},inspectListOrder:function(e){alert(ToolMan.junkdrawer().serializeList(document.getElementById(e)))},restoreListOrder:function(e){var t=document.getElementById(e);if(t==null)return;var n=ToolMan.cookies().get("list-"+e);if(!n)return;var r=n.split("|");var i=ToolMan.junkdrawer()._itemsByID(t);for(var s=0,o=r.length;s<o;s++){var u=r[s];if(u in i){var a=i[u];t.removeChild(a);t.insertBefore(a,null)}}},_identifier:function(e){var t=ToolMan.junkdrawer().trim;var n;n=t(e.getAttribute("id"));if(n!=null&&n.length>0)return n;n=t(e.getAttribute("itemID"));if(n!=null&&n.length>0)return n;return t(e.innerHTML)},_itemsByID:function(e){var t=new Array;var n=e.getElementsByTagName("li");for(var r=0,i=n.length;r<i;r++){var s=n[r];t[ToolMan.junkdrawer()._identifier(s)]=s}return t},trim:function(e){if(e==null)return null;return e.replace(/^(\s+)?(.*\S)(\s+)?$/,"$2")}};ToolMan._eventsFactory={fix:function(e){if(!e)e=window.event;if(e.target){if(e.target.nodeType==3)e.target=e.target.parentNode}else if(e.srcElement){e.target=e.srcElement}return e},register:function(e,t,n){if(e.addEventListener){e.addEventListener(t,n,false)}else if(e.attachEvent){if(!e._listeners)e._listeners=new Array;if(!e._listeners[t])e._listeners[t]=new Array;var r=function(){n.apply(e,new Array)};e._listeners[t][n]=r;e.attachEvent("on"+t,r)}},unregister:function(e,t,n){if(e.removeEventListener){e.removeEventListener(t,n,false)}else if(e.detachEvent){if(e._listeners&&e._listeners[t]&&e._listeners[t][n]){e.detachEvent("on"+t,e._listeners[t][n])}}}};ToolMan._cssFactory={readStyle:function(e,t){if(e.style[t]){return e.style[t]}else if(e.currentStyle){return e.currentStyle[t]}else if(document.defaultView&&document.defaultView.getComputedStyle){var n=document.defaultView.getComputedStyle(e,null);return n.getPropertyValue(t)}else{return null}}};ToolMan._coordinatesFactory={create:function(e,t){return new _ToolManCoordinate(this,e,t)},origin:function(){return this.create(0,0)},topLeftPosition:function(e){var t=parseInt(ToolMan.css().readStyle(e,"left"));var t=isNaN(t)?0:t;var n=parseInt(ToolMan.css().readStyle(e,"top"));var n=isNaN(n)?0:n;return this.create(t,n)},bottomRightPosition:function(e){return this.topLeftPosition(e).plus(this._size(e))},topLeftOffset:function(e){var t=this._offset(e);var n=e.offsetParent;while(n){t=t.plus(this._offset(n));n=n.offsetParent}return t},bottomRightOffset:function(e){return this.topLeftOffset(e).plus(this.create(e.offsetWidth,e.offsetHeight))},scrollOffset:function(){if(window.pageXOffset){return this.create(window.pageXOffset,window.pageYOffset)}else if(document.documentElement){return this.create(document.body.scrollLeft+document.documentElement.scrollLeft,document.body.scrollTop+document.documentElement.scrollTop)}else if(document.body.scrollLeft>=0){return this.create(document.body.scrollLeft,document.body.scrollTop)}else{return this.create(0,0)}},clientSize:function(){if(window.innerHeight>=0){return this.create(window.innerWidth,window.innerHeight)}else if(document.documentElement){return this.create(document.documentElement.clientWidth,document.documentElement.clientHeight)}else if(document.body.clientHeight>=0){return this.create(document.body.clientWidth,document.body.clientHeight)}else{return this.create(0,0)}},mousePosition:function(e){e=ToolMan.events().fix(e);return this.create(e.clientX,e.clientY)},mouseOffset:function(e){e=ToolMan.events().fix(e);if(e.pageX>=0||e.pageX<0){return this.create(e.pageX,e.pageY)}else if(e.clientX>=0||e.clientX<0){return this.mousePosition(e).plus(this.scrollOffset())}},_size:function(e){return this.create(e.offsetWidth,e.offsetHeight)},_offset:function(e){return this.create(e.offsetLeft,e.offsetTop)}};_ToolManCoordinate.prototype={toString:function(){return"("+this.x+","+this.y+")"},plus:function(e){return this.factory.create(this.x+e.x,this.y+e.y)},minus:function(e){return this.factory.create(this.x-e.x,this.y-e.y)},min:function(e){return this.factory.create(Math.min(this.x,e.x),Math.min(this.y,e.y))},max:function(e){return this.factory.create(Math.max(this.x,e.x),Math.max(this.y,e.y))},constrainTo:function(e,t){var n=e.min(t);var r=e.max(t);return this.max(n).min(r)},distance:function(e){return Math.sqrt(Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2))},reposition:function(e){e.style["top"]=this.y+"px";e.style["left"]=this.x+"px"}};ToolMan._dragFactory={createSimpleGroup:function(e,t){t=t?t:e;var n=this.createGroup(e);n.setHandle(t);n.transparentDrag();n.onTopWhileDragging();return n},createGroup:function(e){var t=new _ToolManDragGroup(this,e);var n=ToolMan.css().readStyle(e,"position");if(n=="static"){e.style["position"]="relative"}else if(n=="absolute"){ToolMan.coordinates().topLeftOffset(e).reposition(e)}t.register("draginit",this._showDragEventStatus);t.register("dragmove",this._showDragEventStatus);t.register("dragend",this._showDragEventStatus);return t},_showDragEventStatus:function(e){window.status=e.toString()},constraints:function(){return this._constraintFactory},_createEvent:function(e,t,n){return new _ToolManDragEvent(e,t,n)}};_ToolManDragGroup.prototype={setHandle:function(e){var t=ToolMan.events();e.toolManDragGroup=this;t.register(e,"mousedown",this._dragInit);e.onmousedown=function(){return false};if(this.element!=e)t.unregister(this.element,"mousedown",this._dragInit)},register:function(e,t){this._listeners[e].push(t)},addTransform:function(e){this._transforms.push(e)},verticalOnly:function(){this.addTransform(this.factory.constraints().vertical())},horizontalOnly:function(){this.addTransform(this.factory.constraints().horizontal())},setThreshold:function(e){this._thresholdDistance=e},transparentDrag:function(e){var e=typeof e!="undefined"?e:.75;var t=ToolMan.css().readStyle(this.element,"opacity");this.register("dragstart",function(t){var n=t.group.element;n.style.opacity=e;n.style.filter="alpha(opacity="+e*100+")"});this.register("dragend",function(e){var n=e.group.element;n.style.opacity=t;n.style.filter="alpha(opacity=100)"})},onTopWhileDragging:function(e){var e=typeof e!="undefined"?e:1e5;var t=ToolMan.css().readStyle(this.element,"z-index");this.register("dragstart",function(t){t.group.element.style.zIndex=e});this.register("dragend",function(e){e.group.element.style.zIndex=t})},_dragInit:function(e){e=ToolMan.events().fix(e);var t=document.toolManDragGroup=this.toolManDragGroup;var n=t.factory._createEvent("draginit",e,t);t._isThresholdExceeded=false;t._initialMouseOffset=n.mouseOffset;t._grabOffset=n.mouseOffset.minus(n.topLeftOffset);ToolMan.events().register(document,"mousemove",t._drag);document.onmousemove=function(){return false};ToolMan.events().register(document,"mouseup",t._dragEnd);t._notifyListeners(n)},_drag:function(e){e=ToolMan.events().fix(e);var t=ToolMan.coordinates();var n=this.toolManDragGroup;if(!n)return;var r=n.factory._createEvent("dragmove",e,n);var s=r.mouseOffset.minus(n._grabOffset);if(!n._isThresholdExceeded){var o=r.mouseOffset.distance(n._initialMouseOffset);if(o<n._thresholdDistance)return;n._isThresholdExceeded=true;n._notifyListeners(n.factory._createEvent("dragstart",e,n))}for(i in n._transforms){var u=n._transforms[i];s=u(s,r)}var a=s.minus(r.topLeftOffset);var f=r.topLeftPosition.plus(a);f.reposition(n.element);r.transformedMouseOffset=s.plus(n._grabOffset);n._notifyListeners(r);var l=s.minus(t.topLeftOffset(n.element));if(l.x!=0||l.y!=0){t.topLeftPosition(n.element).plus(l).reposition(n.element)}},_dragEnd:function(e){e=ToolMan.events().fix(e);var t=this.toolManDragGroup;var n=t.factory._createEvent("dragend",e,t);t._notifyListeners(n);this.toolManDragGroup=null;ToolMan.events().unregister(document,"mousemove",t._drag);document.onmousemove=null;ToolMan.events().unregister(document,"mouseup",t._dragEnd)},_notifyListeners:function(e){var t=this._listeners[e.type];for(i in t){t[i](e)}}};_ToolManDragEvent.prototype={toString:function(){return"mouse: "+this.mousePosition+this.mouseOffset+"    "+"xmouse: "+this.transformedMouseOffset+"    "+"left,top: "+this.topLeftPosition+this.topLeftOffset}};ToolMan._dragFactory._constraintFactory={vertical:function(){return function(e,t){var n=t.topLeftOffset.x;return e.x!=n?e.factory.create(n,e.y):e}},horizontal:function(){return function(e,t){var n=t.topLeftOffset.y;return e.y!=n?e.factory.create(e.x,n):e}}};ToolMan._dragsortFactory={makeSortable:function(e){var t=ToolMan.drag().createSimpleGroup(e);t.register("dragstart",this._onDragStart);t.register("dragmove",this._onDragMove);t.register("dragend",this._onDragEnd);return t},makeListSortable:function(e){var t=ToolMan.helpers();var n=ToolMan.coordinates();var r=e.getElementsByTagName("li");t.map(r,function(t){var r=dragsort.makeSortable(t);r.setThreshold(4);var i,s;r.addTransform(function(e,t){return e.constrainTo(i,s)});r.register("dragstart",function(){var t=e.getElementsByTagName("li");i=s=n.topLeftOffset(t[0]);for(var r=1,o=t.length;r<o;r++){var u=n.topLeftOffset(t[r]);i=i.min(u);s=s.max(u)}})});for(var i=1,s=arguments.length;i<s;i++)t.map(r,arguments[i])},_onDragStart:function(e){},_onDragMove:function(e){var t=ToolMan.helpers();var n=ToolMan.coordinates();var r=e.group.element;var i=e.transformedMouseOffset;var s=null;var o=t.previousItem(r,r.nodeName);while(o!=null){var u=n.bottomRightOffset(o);if(i.y<=u.y&&i.x<=u.x){s=o}o=t.previousItem(o,r.nodeName)}if(s!=null){t.moveBefore(r,s);return}var a=t.nextItem(r,r.nodeName);while(a!=null){var f=n.topLeftOffset(a);if(f.y<=i.y&&f.x<=i.x){s=a}a=t.nextItem(a,r.nodeName)}if(s!=null){t.moveBefore(r,t.nextItem(s,r.nodeName));return}},_onDragEnd:function(e){ToolMan.coordinates().create(0,0).reposition(e.group.element)}};
